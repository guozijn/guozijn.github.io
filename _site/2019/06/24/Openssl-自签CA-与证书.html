<h2 id="使用自签发的ca签发子证书">使用自签发的CA签发子证书</h2>

<h3 id="生成-ca">生成 CA</h3>

<ul>
  <li>创建目录</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">TLS_DIR</span><span class="o">=</span>/etc/kolla/tls
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs
</code></pre></div></div>

<ul>
  <li>生成 CA 证书私钥</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem
</code></pre></div></div>

<ul>
  <li>生成 CA 证书签发申请文件</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=Shanghai/L=Shanghai/O=server/CN=server"</span> <span class="nt">-new</span> <span class="nt">-key</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/ca.csr
</code></pre></div></div>

<ul>
  <li>自签发 CA 证书</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 36500 <span class="nt">-extensions</span> v3_ca <span class="nt">-signkey</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem <span class="nt">-in</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/ca.csr <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/ca.crt
</code></pre></div></div>

<h3 id="用-ca-根证书签发子证书">用 CA 根证书签发子证书</h3>

<ul>
  <li>设置 commonName(FQDN)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">COMMONNAME</span><span class="o">=</span>example.com
</code></pre></div></div>

<ul>
  <li>生成子证书私钥</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.pem
</code></pre></div></div>

<ul>
  <li>生成子证书签发申请文件</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=Shanghai/L=Shanghai/O=server/CN=</span><span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-new</span> <span class="nt">-key</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.pem <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.csr
</code></pre></div></div>

<ul>
  <li>用自签发的 CA 根证书签发子证书</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-req</span> <span class="nt">-days</span> 36500 <span class="nt">-extensions</span> v3_req <span class="nt">-CA</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/ca.crt <span class="nt">-CAkey</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem <span class="nt">-set_serial</span> 01 <span class="nt">-in</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.csr <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.crt
</code></pre></div></div>

<ul>
  <li>查看证书内容</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-in</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.crt <span class="nt">-text</span> <span class="nt">-noout</span>
</code></pre></div></div>

<h3 id="生成脚本">生成脚本</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Following environment variables can be overwritten.</span>
<span class="c"># TLS_DIR: The location where the certificate stored.</span>
<span class="c"># COMMONNAME: FQDN or IP address.</span>

<span class="nv">TLS_DIR</span><span class="o">=</span><span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">:-</span><span class="p">/etc/kolla/tls</span><span class="k">}</span>
<span class="nv">COMMONNAME</span><span class="o">=</span><span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">:-</span><span class="nv">example</span><span class="p">.com</span><span class="k">}</span>

<span class="c"># Create directories</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs

<span class="c"># Generate CA</span>
openssl genrsa <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem
openssl req <span class="nt">-new</span> <span class="se">\</span>
    <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=Shanghai/L=Shanghai/O=server/CN=CAserver"</span> <span class="se">\</span>
    <span class="nt">-key</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem <span class="se">\</span>
    <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/ca.csr
openssl x509 <span class="nt">-req</span> <span class="se">\</span>
    <span class="nt">-days</span> 36500 <span class="se">\</span>
    <span class="nt">-extensions</span> v3_ca <span class="se">\</span>
    <span class="nt">-signkey</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem <span class="se">\</span>
    <span class="nt">-in</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/ca.csr <span class="se">\</span>
    <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/ca.crt

<span class="c"># Generate certificates(leaf)</span>
openssl genrsa <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.pem
openssl req <span class="nt">-new</span> <span class="se">\</span>
    <span class="nt">-subj</span> <span class="s2">"/C=CN/ST=Shanghai/L=Shanghai/O=server/CN=</span><span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-key</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.pem <span class="se">\</span>
    <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.csr
openssl x509 <span class="nt">-req</span> <span class="se">\</span>
    <span class="nt">-days</span> 36500 <span class="se">\</span>
    <span class="nt">-extensions</span> v3_req <span class="se">\</span>
    <span class="nt">-CA</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/ca.crt <span class="se">\</span>
    <span class="nt">-CAkey</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/cakey.pem <span class="se">\</span>
    <span class="nt">-set_serial</span> 01 <span class="se">\</span>
    <span class="nt">-in</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/private/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.csr <span class="se">\</span>
    <span class="nt">-out</span> <span class="k">${</span><span class="nv">TLS_DIR</span><span class="k">}</span>/certs/<span class="k">${</span><span class="nv">COMMONNAME</span><span class="k">}</span>.crt
</code></pre></div></div>
